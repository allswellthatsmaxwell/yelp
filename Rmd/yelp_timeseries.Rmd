---
title: "Yelp Review Frequency"
author: "Maxwell Peterson"
output: pdf_document
bibliography: yelp.bib
---

# When do people post Yelp reviews?

```{r include = FALSE, echo = FALSE}
NMIN_TO_COUNT <- 100
fmt_text_date <- function(dt) format(dt, "%B %d, %Y")
knitr::opts_chunk$set(fig.width = 22, fig.height = 12)
pdf_gg_facet_theme <- list(theme(strip.text.x = element_text(size = 22),
                                 axis.text = element_text(size = 22),
                                 axis.text.x = element_text(angle = 90),
                                 axis.title = element_text(size = 28)))
```

The number of reviews posted to Yelp per day is a proxy to
a number of interesting questions. Is Yelp usage still growing? What days of
the week do people visit restaurants? Do people go out on holidays (or: are
restaurants open on holidays?)?

## Input Data
Input data is a subset of Yelp data. Data was provided for 11 metropolitan areas.
Dates range from `r fmt_text_date(.min_date)` to
`r fmt_text_date(.max_date)`. We examine trends at the state and province level
(from here-on just "states"). Input data contains reviews from
`r .number_of_states` states, but not all states saw enough Yelp activity to
say interesting things about; just
`r .count_n_above(.all_time_reviews_by_state, NMIN_TO_COUNT)`
had more than `r NMIN_TO_COUNT` reviews all-time. If this seems low, note that
the publicly-available data is only a small subset of Yelp's data, and than
some very small "states" are likely just incorrectly marked (e.g. state "01")

Part of our objective will be to forecast future review counts. So we'll
keep only those states that have a decent amount of activity in the recent past.
Specifically, we only analyze states with `r MIN_REVIEWS_IN_YEAR` or more
reviews in the year `r YEAR`.  These are:
```{r include = TRUE, echo = FALSE, results = "asis"}
xtable::xtable(.states_to_use_counts, align = "llr") %>%
  print(type = "latex", include.rownames = FALSE, comment = FALSE)
```

Going forward, we only use these states.

\pagebreak
      	
### Reviews Per Day
Reviews per day per state all-time activity.
Note that each y axis is different.

```{r include = TRUE, echo = FALSE, dpi = 70}
.daily_review_counts_plot + pdf_gg_facet_theme
```

Observe:
	
* There is an upward trend in most states.
  
    This makes sense -- Yelp was founded
    in 2004. More people learned of the site over time and so reviews grew over time.
    What's interesting is the states that *didn't* trend upward over the past 12 years:
    Baden-Wurttemburg in Germany, and the Edinburg region in Scotland. A few
    possible explanations:

    + Competition
    
        Yelp did have a serious European competitor: Qype. In May 2012, Qype 
        may have had as much as 5 times Yelp's traffic [@qype_traffic].
	Yelp bought Qype 5 months later [@qype_merger], and the beginning of an
	upward trend in Baden-Wurttemburg happens around the same time!
	But it doesn't continue.

* Large, infrequent spikes downward in reviews posted

    This is most obvious in Arizona, but is the case in many states, including
    the two Canadian provinces. These are probably the big winter holidays.

* Infrequent high outliers

    At least Illinois, Wisconsin, and Quebec have a few days with a very high
    number of reviews.

* South Carolina
    South Carolina's utilization looks odd, but there are very few reviews
    in the state.

#### Outliers
There are outliers in the dataset. We'd like to know:

* Did the single dramatic spikes upward in the two European countries occur
  on the same day?

* Do the yearly dips in AZ, PA OH, WI, and more fall on Christmas, or
  Thanksgiving?

To answer these questions, any rough definition of outliers will do.
We just need a scheme that picks up the outliers obvious to the eye, 
and that doesn't pick up too many days.
We landed on taking those days that were 4 or more standard deviations from
the yearly-detrended mean. In other words: we removed the upward trend from
each state, then took the points that were unusually far away from the average.
Then graphically, the average is the horizontal white line and the
outliers are the red triangles:

```{r include = TRUE, echo = FALSE, dpi = 70}
.daily_review_counts_plot_w_outliers + pdf_gg_facet_theme +
    guides(color = FALSE, shape = FALSE)
```

The far-away view suggests that the Baden-Wurttemburg outlier spike
and the Edinburg spike may fall on the same days. But closer examination
is less exciting:

```{r include = TRUE, echo = FALSE, dpi = 70, fig.height = 1.2, fig.width = 5.7}
.european_outliers_plot + theme(axis.title.y = element_blank(),
                                axis.text.y = element_text(size = 12),
                                axis.text.x = element_text(size = 12,
                                                           angle = 90))
```

Though the outlier  days sometimes overlap for the two regions,
the patterns are less similar than the red-triangled outlier plot suggested.


*****